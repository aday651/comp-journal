---
title: "ACS data on Atlanta and the wider metropoliton area"
output:
  html_document:
    toc: true
    toc_depth: 4
    number_sections: true
    theme: flatly
    toc_float:
        collapsed: false
    highlight: pygments
    fig_caption: true
    fig_width: 10
    fig_height: 8
    df_print: paged
    self_contained: false
---

```{r, include = FALSE}
setwd("/mnt/c/Users/adavi/Documents/comp-journal/ajc-satellite/data-findings/")
options(width = 1200)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(tidyverse)
library(tidycensus)
library(lubridate)
library(zoo)
library(sf)
library(viridis)
```

# Geographic units and time period(s) considered

Throughout, we will consider different geographic units, corresponding to
various collections of counties, and other unified geographical areas corresponding
to different parts of the landscape.

```{r}
core_counties <- c(
    "Fulton", "DeKalb", "Gwinnett", "Cobb", "Clayton"
)

arc_counties <- c(
    "Fulton", "DeKalb", "Gwinnett", "Cobb", "Clayton", "Forsyth",
    "Cherokee", "Douglas", "Fayette", "Henry", "Rockdale"
)

atlanta_msa_1 <- c(
    'Fulton', 'Gwinnett',
    'Cobb', 'DeKalb', 'Clayton',
    'Cherokee', 'Forsyth',
    'Henry', 'Paulding', 'Coweta',
    'Douglas', 'Fayette', 'Carroll',
    'Newton', 'Bartow', 'Walton', 
    'Rockdale'
)

atlanta_msa_2 <- c(
    'Barrow', 'Spalding', 'Pickens', 
    'Haralson', 'Dawson', 'Butts', 
    'Meriwether', 'Morgan',
    'Pike', 'Lamar', 'Jasper', 'Heard'
)

atlanta_msa <- c(atlanta_msa_1, atlanta_msa_2)
```

Throughout, we will frequently use ACS data; for ACS 1 year estimates, we use data
from 2009 to 2019 (we note that [2020 data has not been released](
    https://www.census.gov/newsroom/press-releases/2021/changes-2020-acs-1-year.html
) as a result of the COVID pandemic adversely affecting data collection), and for
ACS 5 year estimates, we use data from 2009 to 2020.

```{r}
years_acs1 <- lst(
    2009, 2010, 2011, 2012, 2013, 2014,
    2015, 2016, 2017, 2018, 2019
)

years_acs5 <- lst(
    2010, 2011, 2012, 2013, 2014, 
    2015, 2016, 2017, 2018, 2019, 2020
)
```

## Defining inside and outside the perimeter

Here, we will consider the I-285 ringroad as defining the "perimeter"
of the "main" part of Atlanta, and will consider anything inside of this
as being "inside the perimeter" (or ITP), and anything outside as
"outside the perimeter" (or OTP). The shape file for the ringroad is available
[online](https://opendata.atlantaregional.com/datasets/929e158242f24c9fb260606526b7d80e).

```{r}
highways <- sf::st_read("../data/georgia-highways.geojson")

it_285 <- highways %>%
    filter(str_detect(ROAD_NAME, "285")) %>%
    select(ROAD_NAME, geometry)

it_285 <- it_285[c(1, 3), ]
itp <- st_union(st_convex_hull(it_285))
```

As is visible from the plot below, the ringroad does not necessarily
line up nicely with the county divisions within Georgia: the perimeter
is highlighted in red, with the regular counties highlighted in black.
However, the census tracts (in grey) do line up more nicely with the
perimeter, albeit not exactly. 

```{r}
arc_counties_shp <- sf::st_read("../ga-counties/Counties_Georgia.shp") %>%
    filter(NAME10 %in% arc_counties) %>%
    select(NAME10, COUNTYFP10, geometry)

arc_tracts_shp <- sf::st_read("../ga-tracts-2020/tl_2020_13_tract.shp") %>%
    filter(COUNTYFP %in% arc_counties_shp$COUNTYFP10)

highway_arc <- st_intersection(highways, arc_counties_shp)

ggplot() +
    geom_sf(data = arc_tracts_shp, colour = "grey", fill = NA) +
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = itp, colour = "red", fill = NA)
```

Ultimately, we want to try and assign each census tract to being ITP
or OTP. Firstly, to handle this, we count the number of tracts (where we
use the 2020 Census Tracts) which intersect with the "perimeter" itself.

```{r}
ics <- st_intersects(
    st_transform(st_boundary(itp), crs = 4269),
    arc_tracts_shp
)

print(paste(
    "Number of census tracts intersecting the interstate:",
    length(ics[[1]])
))
```

As we can see, a small but non-zero number fall inside of this category, and
so we will keep track of:

- census tracts inside the perimeter (ITP),
- census tracts on the perimeter (TP), and
- census tracts outside the perimeter (OTP).

```{r}
arc_tracts_shp <- arc_tracts_shp %>% 
    select(NAME, COUNTYFP, TRACTCE, geometry) %>%
    mutate(
        tp = st_intersects(
            st_transform(st_boundary(itp), crs = 4269),
            geometry, sparse = FALSE
        )[1, ],
        itp = st_within(
            geometry,
            st_transform(itp, crs = 4269), sparse = FALSE
        )[, 1],
        otp = !tp & !itp
    )

arc_tracts_shp %>% 
    st_drop_geometry() %>%
    summarize(
        tp = sum(tp), itp = sum(itp), otp = sum(otp)
    )
```

```{r}
arc_tracts_shp2 <- arc_tracts_shp %>%
    pivot_longer(
        cols = c(tp, itp, otp),
        names_to = "class",
        values_to = "in_class"
    ) %>%
    filter(in_class == TRUE) %>%
    select(-in_class)

ggplot() +
    geom_sf(
        data = arc_tracts_shp2, colour = "grey",
        mapping = aes(fill = class)
    ) +
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = itp, colour = "red", fill = NA) +
    coord_sf(xlim = c(-84.6, -84), ylim = c(33.4, 34), expand = TRUE)
```

# Household income distribution in the Atlanta metro area between 2009 and 2019

```{r, include = FALSE}
v11 <- load_variables(2011, "acs1", cache = TRUE)

income_variables <- paste0("B19001_0", str_pad(1:17, 2, pad = "0"))

income_var_labels <- v11 %>%
    filter(name %in% income_variables) %>%
    select(label) %>% as_vector()

income_var_labels <- sapply(
    str_split(income_var_labels, "!!"), tail, 1
)

income_var_list <- setNames(as.list(income_variables), income_var_labels)

df_income_distribution <- map_dfr(
    years_acs1,
    ~ get_acs(
        geography = "county",
        state = "GA",
        variables = income_var_list,
        year = .x,
        county = arc_counties,
        survey = "acs1",
        geometry = FALSE
    ),
    .id = "year") %>%
    mutate(
        county = gsub("^(.*?),.*", "\\1", NAME)
    ) %>% select(-NAME) %>% relocate(county, .after = GEOID)

df_income_distribution <- df_income_distribution %>%
    mutate(variable = fct_collapse(variable, 
            "Less than $50,000" = c(
                "Less than $10,000", "$10,000 to $14,999", 
                "$15,000 to $19,999", "$20,000 to $24,999",
                "$25,000 to $29,999", "$30,000 to $34,999",
                "$35,000 to $39,999", "$40,000 to $44,999",
                "$45,000 to $49,999"
            ),
            "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
            "$75,000 to $99,999" = c("$75,000 to $99,999"),
            "$100,000 to $149,999" = c(
                "$100,000 to $124,999", "$125,000 to $149,999"
            ),
            "$150,000 to $199,999" = c("$150,000 to $199,999"),
            "$200,000 or more" = c("$200,000 or more")
        )) %>%
    group_by(year, GEOID, county, variable) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    )

income_var_labels <- c(
    "Less than $50,000", "$50,000 to $74,999",
    "$75,000 to $99,999", "$100,000 to $149,999",
    "$150,000 to $199,999", "$200,000 or more"
)
```

ACS 1-year data from 2009 to 2019, showing the number of households (with
error estimates) which lie in particular income bands across the ARC counties.

```{r}
df_income_distribution
```

## How has the income distribution changed over the years across the Atlanta area?

To answer this, we summarize over all the counties the number of households in
each income bracket, along with the total number, and do so for each year. The margin
of errors give 90% confidence intervals of each estimate; to get the margin of error for
a sum of variables, we sum the square of the margin of error across all the variables,
and then take the square root. For this analysis, we look at all the counties
which belong to the Altanta Regional Commission. 

### Looking at number of households

```{r}
df_income_dist_summary <- df_income_distribution %>%
    select(year, county, variable, estimate, moe) %>%
    group_by(year, variable) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>%
    ungroup() %>%
    mutate(
        variable = factor(variable, ordered = TRUE,
        levels = income_var_labels)
    ) %>%
    filter(variable != "Total")

df_income_dist_summary

require(scales)

ggplot(df_income_dist_summary, aes(x = variable, y = estimate)) + 
    facet_wrap(~ year) +
    geom_col() +
    geom_errorbar(aes(ymin = estimate - moe, ymax = estimate + moe)) +
    labs(
        x = "Income band", y = "Number of households",
        title = "Distribution of Household Income in the Atlanta area Between 2009 and 2019"
    ) + scale_y_continuous(labels = comma) +
    coord_flip()
```

```{r}
df_income_dist_summary %>%
    mutate(year = as.Date(paste(year, 1, 1, sep = "-"))) %>%
    ggplot(aes(
        x = year, y = estimate, col = variable, fill = variable,
        ymin = estimate - moe, ymax = estimate + moe)
    ) + geom_point() + geom_line() + geom_ribbon(alpha = 0.2) +
    labs(
        x = "Year", y = "Number of households",
        col = "Income band"
    )
```

### Looking at the proportion of households

```{r}
df_income_prop_summary <- df_income_distribution %>%
    select(year, county, variable, estimate, moe) %>%
    group_by(year, variable) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>%
    ungroup() %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    filter(variable != "Total") %>%
    group_by(year) %>%
    mutate(
        moe = moe / sum(estimate),
        estimate = estimate / sum(estimate),
    )

df_income_prop_summary

ggplot(df_income_prop_summary, aes(x = variable, y = estimate)) + 
    facet_wrap(~ year) +
    geom_col() +
    geom_errorbar(aes(ymin = estimate - moe, ymax = estimate + moe)) +
    labs(
        x = "Income band", y = "Proportion of households",
        title = "Distribution of Household Income in the Atlanta area Between 2009 and 2019"
    ) + scale_y_continuous(labels = comma) + coord_flip()
```

### Change between 2009 and 2019

Looking at the number of households in each income band at 2009 and 2019, we can see
that there has been a large increase in the number of households earning $100k or more,
while the number of households earning less than $50k has mostly stayed constant. 

```{r}
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

df_income_dist_summary %>%
    filter(year %in% c(2009, 2019)) %>%
    mutate(year = factor(year)) %>%
    ggplot(aes(x = variable, y = estimate, fill = year)) +
    geom_col(position = "dodge") +
    geom_errorbar(
        aes(ymin = estimate - moe, ymax = estimate + moe), 
        position = "dodge"
    ) + scale_fill_manual(values = cbPalette) +
    geom_text(
        aes(label = year, y = 10000), 
        position = position_dodge(width = 1),
        size = 5, hjust = 'left',
        col = "white"
    ) + 
    labs(
        y = "Number of households", x = "Income band",
        title = "Distribution of Household Income in the Atlanta area (2009 and 2019)", fill = "Year",
        subtitle = "Data from the 1-year ACS from 2009 and 2019"
    ) + scale_y_continuous(labels = comma) +
    coord_flip() + theme(legend.position = "none")
```

### Changes across counties over time

```{r}
df_income_distribution %>%
    select(year, county, variable, estimate, moe) %>%
    filter(variable != "Total") %>%
    group_by(year, county) %>%
    mutate(estimate = estimate / sum(estimate)) %>%
    ungroup() %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    ggplot(aes(x = year, y = estimate, fill = forcats::fct_rev(variable))) +
    facet_wrap(~ county, scales = "free") +
    geom_col() + coord_flip() +
    labs(
        x = "Year", y = "Number of Households", fill = "Income Band",
        title = "Distribution of Household Income across Counties and Year"
    ) +
    theme(legend.position = "bottom")
```

## How has the income distribution changed ITP and OTP from 2009 to 2019?

We note that between the 2009 5-year ACS estimates and the 2020 5-year ACS estimates,
the number of census tracts has changed, and therefore we will compute for each census
tract (in each year period) whether it was ITP, TP or OTP.

```{r, results = 'hide'}
df_income_tracts <- map_dfr(
    lst(2009, 2020),
    ~ get_acs(
        geography = "tract",
        state = "GA",
        variables = income_var_list,
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = FALSE
    ),
    .id = "year") %>%
    mutate(
        tract = gsub("^(.*?),.*", "\\1", NAME),
        county = gsub("^(.*?), (.*?),.*", "\\2", NAME)
    ) %>% 
    select(-NAME) %>%
    relocate(tract, county, .after = GEOID)

df_tracts_peri_shp <- map_dfr(
    lst(2009, 2020),
    ~ get_acs(
        geography = "tract",
        state = "GA",
        variables = "B19001_001",
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = TRUE
    ),
    .id = "year") %>% 
    select(year, GEOID, geometry) %>%
    mutate(
        tp = st_intersects(
            st_transform(st_boundary(itp), crs = 4269),
            geometry, sparse = FALSE
        )[1, ],
        itp = st_within(
            geometry,
            st_transform(itp, crs = 4269), sparse = FALSE
        )[, 1],
        otp = !tp & !itp
    ) %>%
    pivot_longer(
        cols = c(tp, itp, otp),
        names_to = "class",
        values_to = "in_class"
    ) %>%
    filter(in_class == TRUE)

df_tracts <- map_dfr(
    lst(2009, 2020),
    ~ get_acs(
        geography = "tract",
        state = "GA",
        variables = "B19001_001",
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = TRUE
    ),
    .id = "year") %>% 
    select(year, GEOID, geometry) %>%
    mutate(
        tp = st_intersects(
            st_transform(st_boundary(itp), crs = 4269),
            geometry, sparse = FALSE
        )[1, ],
        itp = st_within(
            geometry,
            st_transform(itp, crs = 4269), sparse = FALSE
        )[, 1],
        otp = !tp & !itp
    ) %>%
    pivot_longer(
        cols = c(tp, itp, otp),
        names_to = "class",
        values_to = "in_class"
    ) %>%
    filter(in_class == TRUE) %>%
    select(-in_class)

df_tracts_peri <- df_tracts %>% st_drop_geometry()

df_income_tracts %>%
    filter(variable != "Total") %>%
    left_join(df_tracts_peri) %>%
    select(year, class, variable, estimate, moe) %>%
    mutate(variable = fct_collapse(variable, 
            "Less than $50,000" = c(
                "Less than $10,000", "$10,000 to $14,999", 
                "$15,000 to $19,999", "$20,000 to $24,999",
                "$25,000 to $29,999", "$30,000 to $34,999",
                "$35,000 to $39,999", "$40,000 to $44,999",
                "$45,000 to $49,999"
            ),
            "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
            "$75,000 to $99,999" = c("$75,000 to $99,999"),
            "$100,000 to $149,999" = c(
                "$100,000 to $124,999", "$125,000 to $149,999"
            ),
            "$150,000 to $199,999" = c("$150,000 to $199,999"),
            "$200,000 or more" = c("$200,000 or more")
        )) %>%
    group_by(year, class, variable) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, class) %>%
    mutate(
        moe = moe / sum(estimate),
        estimate = estimate / sum(estimate)
    ) %>%
    ggplot(aes(x = variable, y = estimate, fill = year)) +
    geom_col(position = "dodge") + 
    geom_errorbar(
        aes(ymin = estimate - moe, ymax = estimate + moe),
        position = "dodge"
    ) +
    facet_grid(~ class) +
    labs(x = "Income band", y = "Proportion of households") +
    coord_flip()
```

Examining the three different classes, it appears that the main changes are that
there are an increasing number of households in very high income brackets both
inside and outside the perimeter, and that the number of households on the perimeter
which were in the low income brackets has decreased over the past ten years by
a considerable amount. (If anything, this seems like the most suprising thing
I've found here.)

```{r}
df_income_tracts %>%
    filter(variable != "Total") %>%
    left_join(df_tracts_peri) %>%
    select(year, class, variable, estimate, moe) %>%
    mutate(variable = fct_collapse(variable, 
            "Less than $50,000" = c(
                "Less than $10,000", "$10,000 to $14,999", 
                "$15,000 to $19,999", "$20,000 to $24,999",
                "$25,000 to $29,999", "$30,000 to $34,999",
                "$35,000 to $39,999", "$40,000 to $44,999",
                "$45,000 to $49,999"
            ),
            "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
            "$75,000 to $99,999" = c("$75,000 to $99,999"),
            "$100,000 to $149,999" = c(
                "$100,000 to $124,999", "$125,000 to $149,999"
            ),
            "$150,000 to $199,999" = c("$150,000 to $199,999"),
            "$200,000 or more" = c("$200,000 or more")
        )) %>%
    group_by(year, class, variable) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>% 
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    ggplot(aes(x = variable, y = estimate, fill = year)) +
    geom_col(position = "dodge") + 
    geom_errorbar(
        aes(ymin = estimate - moe, ymax = estimate + moe),
        position = "dodge"
    ) +
    facet_grid(~ class, scales = "free") +
    labs(x = "Income band", y = "Number of households") +
    coord_flip()
```

## How has the income distribution changed across tracts over time?

To compare the income distribution across tracts over time, for each census tract,
we will look at the proportion of the population in the different income bands, and
then compare these between 2010 and 2019. (These time periods were chosen so that
there are no issues in switching between different census tracts.) To do so, we 
will compute the total variation distance (up to a scalar) between the two distributions;
formally, if we have $K$ different possible values, and we have two sets of proportions
labelled $p(i)$ and $q(i)$ (where $i$ can take on $1$, $2$, ..., or $K$), then we compute
the value
$$ |p(1) - q(1)| + |p(2) - q(2)| + \cdots + |p(K) - q(K)|, $$
and use this as a measure of how different $p$ and $q$ are. To try and observe what
is happening in relation to some other geographical structures, the major highways
beyond that of the interstate have also been added to the plots below.
(Apologies for the color blind unfriendly palette.)

```{r, results = 'hide'}
df_income_tracts <- map_dfr(
    lst(2010, 2019),
    ~ get_acs(
        geography = "tract",
        state = "GA",
        variables = income_var_list,
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = FALSE
    ),
    .id = "year") %>%
    mutate(
        tract = gsub("^(.*?),.*", "\\1", NAME),
        county = gsub("^(.*?), (.*?),.*", "\\2", NAME)
    ) %>% 
    select(-NAME) %>%
    relocate(tract, county, .after = GEOID)

df_tracts <- map_dfr(
    lst(2010),
    ~ get_acs(
        geography = "tract",
        state = "GA",
        variables = "B19001_001",
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = TRUE
    ),
    .id = "year") %>% 
    select(GEOID, geometry)

df_total_households_tracts <- df_income_tracts %>%
    filter(variable == 'Total') %>% 
    select(year, GEOID, estimate, moe)

df_total_households_tracts2 <- df_total_households_tracts %>% 
    filter(year == '2019') %>% select(GEOID, estimate)

df_income_change_long <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
            "Less than $50,000" = c(
                "Less than $10,000", "$10,000 to $14,999", 
                "$15,000 to $19,999", "$20,000 to $24,999",
                "$25,000 to $29,999", "$30,000 to $34,999",
                "$35,000 to $39,999", "$40,000 to $44,999",
                "$45,000 to $49,999"
            ),
            "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
            "$75,000 to $99,999" = c("$75,000 to $99,999"),
            "$100,000 to $149,999" = c(
                "$100,000 to $124,999", "$125,000 to $149,999"
            ),
            "$150,000 to $199,999" = c("$150,000 to $199,999"),
            "$200,000 or more" = c("$200,000 or more")
        )) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>%
    ungroup() %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    )

df_income_change_tracts <- df_income_change_long %>%
    group_by(year, GEOID) %>%
    mutate(estimate = estimate / sum(estimate)) %>%
    pivot_wider(
        names_from = year,
        names_prefix = "estimate_",
        values_from = estimate
    ) %>% 
    mutate(
        diff = abs(estimate_2010 - estimate_2019)
    ) %>%
    group_by(GEOID) %>%
    summarize(income_dist_change = 0.5*sum(diff)) %>%
    left_join(df_tracts)

df_income_change_overall <- df_income_change_long %>%
    group_by(year) %>%
    mutate(estimate = estimate / sum(estimate)) %>%
    pivot_wider(
        names_from = year,
        names_prefix = "estimate_",
        values_from = estimate
    ) %>% 
    mutate(
        diff = abs(estimate_2010 - estimate_2019)
    ) %>%
    summarize(income_dist_change = 0.5 * sum(diff))

plot(
    df_total_households_tracts2$estimate, df_income_change_tracts$income_dist_change,
    xlab = "Number of households in census tract",
    ylab = "Total variation of income distribution change in census tract",
    main = "Number of households vs income change across census tracts",
    sub = "(Horizontal red line corresponds to level of income change across all Atlanta)"
) 
abline(h = as.numeric(df_income_change_overall), col = "red", lwd = 3)

df_income_change_tracts %>% 
    select(-geometry) %>%
    ggplot(aes(x = income_dist_change)) +
    geom_histogram() +
    geom_vline(
        xintercept = as.numeric(df_income_change_overall),
        col = "red"
    ) +
    labs(
        x = "Total variation distance between income distributions in 2010 and 2019",
        title = "Histogram of total variation distances between income distributions across census tracts",  
        y = "Number of census tracts", 
        subtitle = "(Vertical red line represents the overall distribution change across Atlanta)"
    )

ggplot() +
    geom_sf(
        data = df_income_change_tracts, 
        aes(geometry = geometry, fill = income_dist_change),
        colour = "grey"
    ) + scale_fill_viridis(option = "magma") +
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "green", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Total variation of income distributions",
        title = "Change in income distribution by census tract",
        subtitle = "(Data from the 5 year 2006-2010 and 2015-2019 ACS)"
    )
```

This seems pretty abstract, and so instead we'll look at some "extreme groups":

- households earning more than $200k,
- households earning less than $50k;
- households earning between $50k and $75k;

and see where the numbers of these households/proportions have been 
increasing and decreasing in number the largest. 

```{r, include = FALSE}
library(scales)
symlog_trans <- function(base = 10, thr = 1, scale = 1){
  trans <- function(x)
    ifelse(abs(x) < thr, x, sign(x) * 
             (thr + scale * suppressWarnings(log(sign(x) * x / thr, base))))

  inv <- function(x)
    ifelse(abs(x) < thr, x, sign(x) * 
             base^((sign(x) * x - thr) / scale) * thr)

  breaks <- function(x){
    sgn <- sign(x[which.max(abs(x))])
    if(all(abs(x) < thr))
      pretty_breaks()(x)
    else if(prod(x) >= 0){
      if(min(abs(x)) < thr)
        sgn * unique(c(pretty_breaks()(c(min(abs(x)), thr)),
                       log_breaks(base)(c(max(abs(x)), thr))))
      else
        sgn * log_breaks(base)(sgn * x)
    } else {
      if(min(abs(x)) < thr)
        unique(c(sgn * log_breaks()(c(max(abs(x)), thr)),
                 pretty_breaks()(c(sgn * thr, x[which.min(abs(x))]))))
      else
        unique(c(-log_breaks(base)(c(thr, -x[1])),
                 pretty_breaks()(c(-thr, thr)),
                 log_breaks(base)(c(thr, x[2]))))
    }
  }
  trans_new(paste("symlog", thr, base, scale, sep = "-"), trans, inv, breaks)
}
```

```{r}
df_rdincome_tracts <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
        "Less than $50,000" = c(
            "Less than $10,000", "$10,000 to $14,999", 
            "$15,000 to $19,999", "$20,000 to $24,999",
            "$25,000 to $29,999", "$30,000 to $34,999",
            "$35,000 to $39,999", "$40,000 to $44,999",
            "$45,000 to $49,999"
        ),
        "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
        "$75,000 to $99,999" = c("$75,000 to $99,999"),
        "$100,000 to $149,999" = c(
            "$100,000 to $124,999", "$125,000 to $149,999"
        ),
        "$150,000 to $199,999" = c("$150,000 to $199,999"),
        "$200,000 or more" = c("$200,000 or more")
    )) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>%
    left_join(df_tracts)

p2010 <- ggplot() +
    geom_sf(
        data = df_rdincome_tracts %>% filter(year == '2010'),
        aes(geometry = geometry, fill = estimate),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "viridis", trans = 'sqrt') +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#f100e5", fill = NA) +
    theme(legend.position = "bottom") + 
    labs(
        fill = "Number of households",
        title = "Number of households by income band and tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

p2019 <- ggplot() +
    geom_sf(
        data = df_rdincome_tracts %>% filter(year == '2019'),
        aes(geometry = geometry, fill = estimate),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "viridis", trans = 'log10') +
    facet_wrap(~ variable) +
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#f100e5", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Number of households",
        title = "Number of households by income band and tract",
        subtitle = "(Data using 5-year estimates from the 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

df_rdincome_change_tracts <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
        "Less than $50,000" = c(
            "Less than $10,000", "$10,000 to $14,999", 
            "$15,000 to $19,999", "$20,000 to $24,999",
            "$25,000 to $29,999", "$30,000 to $34,999",
            "$35,000 to $39,999", "$40,000 to $44,999",
            "$45,000 to $49,999"
        ),
        "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
        "$75,000 to $99,999" = c("$75,000 to $99,999"),
        "$100,000 to $149,999" = c(
            "$100,000 to $124,999", "$125,000 to $149,999"
        ),
        "$150,000 to $199,999" = c("$150,000 to $199,999"),
        "$200,000 or more" = c("$200,000 or more")
    )) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>%
    pivot_wider(
        names_from = "year",
        names_prefix = "estimate_",
        values_from = "estimate"
    ) %>%
    mutate(change = estimate_2019 - estimate_2010) %>%
    left_join(df_tracts)

df_rdincome_change_tracts %>%
    ggplot(aes(x = change)) + geom_histogram() +
    facet_wrap(~ variable) + 
    labs(
        x = "Change in number of households", 
        y = "Number of census tracts",
        title = "Change in number of households in different income bands across census tracts", 
        subtitle = "(Data from the 5-year ACS 2006-2010 and 2015-2019)"
    )

ggplot() +
    geom_sf(
        data = df_rdincome_change_tracts,
        aes(geometry = geometry, fill = change),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "turbo") +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#009b00", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Net change in households",
        title = "Change in number of households by income band and tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS and 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))
```

```{r}
df_rdincome_prop_tracts <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
        "Less than $50,000" = c(
            "Less than $10,000", "$10,000 to $14,999", 
            "$15,000 to $19,999", "$20,000 to $24,999",
            "$25,000 to $29,999", "$30,000 to $34,999",
            "$35,000 to $39,999", "$40,000 to $44,999",
            "$45,000 to $49,999"
        ),
        "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
        "$75,000 to $99,999" = c("$75,000 to $99,999"),
        "$100,000 to $149,999" = c(
            "$100,000 to $124,999", "$125,000 to $149,999"
        ),
        "$150,000 to $199,999" = c("$150,000 to $199,999"),
        "$200,000 or more" = c("$200,000 or more")
    )) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>% 
    group_by(year, GEOID) %>%
    mutate(estimate = estimate / sum(estimate)) %>%
    left_join(df_tracts)

pincome2010 <- ggplot() +
    geom_sf(
        data = df_rdincome_prop_tracts %>% filter(year == '2010'),
        aes(geometry = geometry, fill = estimate),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "viridis", trans = 'sqrt') +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#f100e5", fill = NA) +
    theme(legend.position = "bottom") + 
    labs(
        fill = "Proportion of households",
        title = "Proportion of households by income band in census tracts",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

pincome2019 <- ggplot() +
    geom_sf(
        data = df_rdincome_prop_tracts %>% filter(year == '2019'),
        aes(geometry = geometry, fill = estimate),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "viridis", trans = 'log10') +
    facet_wrap(~ variable) +
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#f100e5", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Proportion of households",
        title = "Proportion of households by income band in census tracts",
        subtitle = "(Data using 5-year estimates from the 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

df_rdincome_prop_change_tracts <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
        "Less than $50,000" = c(
            "Less than $10,000", "$10,000 to $14,999", 
            "$15,000 to $19,999", "$20,000 to $24,999",
            "$25,000 to $29,999", "$30,000 to $34,999",
            "$35,000 to $39,999", "$40,000 to $44,999",
            "$45,000 to $49,999"
        ),
        "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
        "$75,000 to $99,999" = c("$75,000 to $99,999"),
        "$100,000 to $149,999" = c(
            "$100,000 to $124,999", "$125,000 to $149,999"
        ),
        "$150,000 to $199,999" = c("$150,000 to $199,999"),
        "$200,000 or more" = c("$200,000 or more")
    )) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>% 
    group_by(year, GEOID) %>%
    mutate(estimate = estimate / sum(estimate)) %>%
    ungroup() %>%
    pivot_wider(
        names_from = "year",
        names_prefix = "estimate_",
        values_from = "estimate"
    ) %>%
    mutate(change = estimate_2019 - estimate_2010) %>%
    left_join(df_tracts)

df_rdincome_prop_change_tracts %>%
    ggplot(aes(x = change)) + geom_histogram() +
    facet_wrap(~ variable)

p1 <- ggplot() +
    geom_sf(
        data = df_rdincome_prop_change_tracts,
        aes(geometry = geometry, fill = change),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "turbo") +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#009b00", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Change in proportion of households",
        title = "Change in proportion of households in income band by tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS and 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

p1
ggsave("income_changes_all.pdf")

p2 <- ggplot() +
    geom_sf(
        data = df_rdincome_prop_change_tracts %>%
            filter(variable %in% c("Less than $50,000", "$200,000 or more")),
        aes(geometry = geometry, fill = change),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "turbo") +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#009b00", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Change in proportion of households",
        title = "Change in proportion of households in income band by tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS and 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

p2
ggsave("income_changes_extreme.pdf")
```

```{r, include = FALSE, eval = FALSE}
tdf <- df_rdincome_prop_change_tracts %>%
    select(GEOID, change, variable) %>%
    filter(variable %in% c("Less than $50,000", "$200,000 or more")) %>%
    pivot_wider(
        names_from = variable,
        values_from = change
    ) %>%
    left_join(
        df_tracts_peri_shp %>% st_drop_geometry() %>% select(GEOID, class)
    ) %>%
    filter(`Less than $50,000` < 0, class == 'otp') %>%
    select(-GEOID, -class)

cor.test(tdf$`Less than $50,000`, tdf$`$200,000 or more`, method = "spearman")

df_rdincome_prop_change_tracts %>%
    select(GEOID, change, variable) %>%
    filter(variable %in% c("Less than $50,000", "$200,000 or more")) %>%
    left_join(
        df_tracts_peri_shp %>% st_drop_geometry() %>% select(GEOID, class)
    ) %>%
    ggplot(aes(x = change, fill = class)) + 
    geom_histogram() +
    facet_grid(variable ~ class)

ggsave("income_changes_histogram.pdf")
```

Let's zoom inside the perimeter to see what is happening here
a bit more carefully.

```{r}
p1 + coord_sf(xlim = c(-84.53, -84.2), ylim = c(33.6, 33.95), expand = FALSE)
ggsave("income_changes_all_itp.pdf")

p2 + coord_sf(xlim = c(-84.53, -84.2), ylim = c(33.6, 33.95), expand = FALSE) 
ggsave("income_changes_extreme_itp.pdf")
```

Let's also just look at the actual numbers of households, rather than the
change in proportions over time. (This should let us see if the effects we
are seeing are due to chance, or are of evidence of an actual pattern). 

```{r}
df_rdincome_total_change_tracts <- df_income_tracts %>%
    filter(variable != "Total") %>%
    select(year, GEOID, variable, estimate) %>%
    mutate(variable = fct_collapse(variable, 
        "Less than $50,000" = c(
            "Less than $10,000", "$10,000 to $14,999", 
            "$15,000 to $19,999", "$20,000 to $24,999",
            "$25,000 to $29,999", "$30,000 to $34,999",
            "$35,000 to $39,999", "$40,000 to $44,999",
            "$45,000 to $49,999"
        ),
        "$50,000 to $74,999" = c("$50,000 to $59,999", "$60,000 to $74,999"),
        "$75,000 to $99,999" = c("$75,000 to $99,999"),
        "$100,000 to $149,999" = c(
            "$100,000 to $124,999", "$125,000 to $149,999"
        ),
        "$150,000 to $199,999" = c("$150,000 to $199,999"),
        "$200,000 or more" = c("$200,000 or more")
    )) %>%
    mutate(
        variable = factor(variable, ordered = TRUE, levels = income_var_labels)
    ) %>%
    group_by(year, GEOID, variable) %>%
    summarize(estimate = sum(estimate)) %>%
    ungroup() %>%
    pivot_wider(
        names_from = "year",
        names_prefix = "estimate_",
        values_from = "estimate"
    ) %>%
    mutate(change = estimate_2019 - estimate_2010) %>%
    left_join(df_tracts)

p1_total <- ggplot() +
    geom_sf(
        data = df_rdincome_total_change_tracts,
        aes(geometry = geometry, fill = change),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "turbo") +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#009b00", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Change in number of households",
        title = "Change in number of households in income band by tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS and 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

p1_total
ggsave("income_changes_all_raw.pdf")

p2_total <- ggplot() +
    geom_sf(
        data = df_rdincome_total_change_tracts %>%
            filter(variable %in% c("Less than $50,000", "$200,000 or more")),
        aes(geometry = geometry, fill = change),
        colour = "grey", lwd = 0.25
    ) + scale_fill_viridis(option = "turbo") +
    facet_wrap(~ variable) + 
    geom_sf(data = arc_counties_shp, colour = "black", fill = NA) +
    geom_sf(data = highway_arc, colour = "#009b00", fill = NA) +
    theme(legend.position = "bottom") +
    labs(
        fill = "Change in number of households",
        title = "Change in number of households in income band by tract",
        subtitle = "(Data using 5-year estimates from the 2006-2010 ACS and 2015-2019 ACS)"
    ) +
    theme(legend.key.width = unit(2, 'cm'))

p2_total
ggsave("income_changes_extreme_raw.pdf")
```

```{r}
p1_total + coord_sf(xlim = c(-84.53, -84.2), ylim = c(33.6, 33.95), expand = FALSE)
ggsave("income_changes_all_itp.pdf")

p2_total + coord_sf(xlim = c(-84.53, -84.2), ylim = c(33.6, 33.95), expand = FALSE) 
ggsave("income_changes_extreme_itp.pdf")
```

# Migration patterns - income of people moving inside census tracts

```{r}
income_variables <- paste0("B07010_0", str_pad(1:66, 2, pad = "0"))

income_variables_df <- v11 %>%
    filter(name %in% income_variables) %>% 
    select(name, label) %>% 
    separate(
        label, 
        c('estimate', 'total', 'moved', 'income', 'band'), 
        sep = "!!"
    ) %>%
    drop_na() %>%
    select(name, moved, band) %>%
    filter(moved != "Moved from abroad") %>%
    mutate(
        in_out_state = fct_collapse(
            as_factor(moved),
            "Stayed in-state" = c(
                "Same house 1 year ago",
                "Moved within same county",
                "Moved from different county within same state",
                "Moved from different state"
            ),
            "Moved from out-of-state" = c("Moved from different state")
        ),
        band = fct_collapse(
            as_factor(band),
            "$1 to $14,999" = c(
                "$1 to $9,999 or loss", "$10,000 to $14,999"
            ),
            "$15,000 to $34,999" = c(
                "$15,000 to $24,999", "$25,000 to $34,999"
            ),
            "$35,000 to $49,999" = "$35,000 to $49,999",
            "$50,000 to $64,999" = "$50,000 to $64,999",
            "$65,000 to $74,999" = "$65,000 to $74,999",
            "$75,000 or more" = "$75,000 or more"
        )
    )

df_income_in <- map_dfr(
    years_acs1,
    ~ get_acs(
        geography = "county",
        state = "GA",
        variables = income_variables,
        year = .x,
        county = arc_counties,
        survey = "acs1",
        geometry = FALSE
    ),
    .id = "year") %>%
    mutate(county = gsub("^(.*?),.*", "\\1", NAME)) %>%
    select(-NAME) %>%
    relocate(county, .after = GEOID)

df_income_in %>%
    left_join(income_variables_df, by = c("variable" = "name")) %>%
    mutate(year = as.Date(paste(year, 1, 1, sep = "-"))) %>%
    drop_na() %>%
    group_by(year, in_out_state, band) %>% 
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>%
    filter(in_out_state == "Moved from out-of-state") %>%
    ggplot(aes(
        x = year, y = estimate, ymin = estimate - moe,
        ymax = estimate + moe, col = band, fill = band)
    ) + geom_line() + 
    geom_point() + 
    geom_ribbon(alpha = 0.15, show.legend = FALSE) +
    theme(legend.position = "bottom") + 
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
    labs(
        x = "Year", y = "Number of Individuals", 
        col = "Individual Income",
        title = "Distribution of income of individuals who moved into Atlanta from out of state",
        subtitle = "Data from 1-year ACS from 2009 to 2019"
    ) +
    guides(fill = "none")

ggsave("income_out_of_state.pdf")

df_income_in_5yr <- map_dfr(
    years_acs5,
    ~ get_acs(
        geography = "county",
        state = "GA",
        variables = income_variables,
        year = .x,
        county = arc_counties,
        survey = "acs5",
        geometry = FALSE
    ),
    .id = "year") %>%
    mutate(county = gsub("^(.*?),.*", "\\1", NAME)) %>%
    select(-NAME) %>%
    relocate(county, .after = GEOID)

df_income_in_5yr %>%
    left_join(income_variables_df, by = c("variable" = "name")) %>%
    mutate(year = as.Date(paste(year, 1, 1, sep = "-"))) %>%
    drop_na() %>%
    group_by(year, in_out_state, band) %>%
    summarize(
        estimate = sum(estimate),
        moe = sqrt(sum(moe**2))
    ) %>%
    filter(in_out_state == "Moved from out-of-state") %>%
    ggplot(aes(
        x = year, y = estimate, ymin = estimate - moe,
        ymax = estimate + moe, col = band, fill = band)
    ) + geom_line() + 
    geom_point() + 
    geom_ribbon(alpha = 0.15, show.legend = FALSE) +
    theme(legend.position = "bottom") + 
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
    labs(
        x = "Year", y = "Number of Individuals", 
        col = "Individual Income",
        title = "Distribution of income of individuals who moved into Atlanta from out of state",
        subtitle = "Data from 5-year ACS from 2005-2009 to 2016-2020 (years not directly comparable)"
    ) +
    guides(fill = "none")
```


## Things to do still

- Make an interactive map of the census tracts, just so I can
easily get their locations to use it for pulling the shape
and looking at the relevant satellite image (e.g, will
use the tract's bounding box for pulling satellite imagery), 
along with the number of households within that census tract (really
need to have a mental image of this too)

- From the satellite imagery, look at 
areas of interest in 2010 as compared to as recently as possible,
see what changes are there
    - The place in Forsyth County ()
    - The place "in the wedge"
    - The place at the intersection of DeKalb and Fulton
    - 11 o-clock in the perimeter

- Extract the land change data from the land use dataset for
each of the years 

## Plans for the weekend:

- Have both a line plot per year, and the bar plot showing
    the change between 2009 and 2019

- Plots for proportion of people moving: threshold the color
changes between -0.15 and 0.15

- Plots for total number of people moving: threshold the color
changes between -500 and 500 households per tract

